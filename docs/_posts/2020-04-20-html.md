---
title: "From Deployment to Defense: How to Set Up Microsoft Defender External Attack Surface Management (MDEASM) using Terraform and Azure DevOps"
date: 2024-09-11
layout: post
---

Introduction...

All code referenced henceforth can be found in my [repo](https://github.com/gwilkinson01/mdeasm-devops/).

## Deployment

MDEASM is not yet supported through Azure Resource Manager (ARM). Nevertheless, you can still deploy using an ARM template if you know the resource provider. For this tutorial, I will reference `Microsoft.Easm/workspaces@2023-04-01-preview` as the resource provider. In case that changes in the future, you can check for the most up to date version [here](https://learn.microsoft.com/en-us/rest/api/defenderforeasm/controlplanepreview/workspaces?view=rest-defenderforeasm-controlplanepreview-2023-04-01-preview).

With the resource provider we can generate our ARM Template, which we will do using a Bicep file: 

```bicep
param name string = 'easm-work'
param region string = 'westeurope'
resource Easm 'Microsoft.Easm/workspaces@2023-04-01-preview' = {
name: name
location: region
properties: {}
}
```

Using Azure CLI run the following command:

`az bicep build mdeasm.bicep`

This will generate an ARM template (main.json) from your Bicep file. 

In my repo I renamed the json file to `easm-deployment.json`. Here's what the template looks like:

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.9.1.41621",
      "templateHash": "10012041125269374402"
    }
  },
  "parameters": {
    "name": {
      "type": "string",
      "defaultValue": "mdeasm1"
    },
    "region": {
      "type": "string",
      "defaultValue": "westeurope"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Easm/workspaces",
      "apiVersion": "2023-04-01-preview",
      "name": "[parameters('name')]",
      "location": "[parameters('region')]",
      "properties": {}
    }
  ]
}
```

### Terraform

We will use Terraform to define and provision MDEASM (and a reosurce group for it to sit in). I won't detail much about using Terraform with Azure DevOps here as there are many tutorials on that subject already. Here are the three Terraform files we're deployment with some important notes:

1. `main.tf` - declare the ARM template to be used here. Note the use of `${path.module}` which ensures to point to the current directory in a way that doesn't throw up any Terraform errors.
2. `variables.tf` 
3. `providers.tf` - Running a Destroy action fails unless `prevent_deletion_if_contains_resources = false` is included.  

To view these files visit my [repo](https://github.com/gwilkinson01/mdeasm-devops/)

The final step we need to take here is to create our yaml file for use in the Azure DevOps pipeline. Here is a basic example of what this might look like:

```yaml
trigger: none 

pool:
  vmImage: 'ubuntu-latest'

steps:
  # Step 1: Install Terraform
  - task: TerraformInstaller@0
    inputs:
      terraformVersion: 'latest'

  # Step 2: Azure CLI to authenticate with Azure
  - task: AzureCLI@2
    inputs:
      azureSubscription: '<YOUR_SERVICE_CONNECTION>'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az account show

  # Step 3: Checkout the code (Terraform and ARM template files)
  - checkout: self

  # Step 4: Terraform Init
  - script: terraform init
    displayName: 'Terraform Init'

  # Step 5: Terraform Plan
  - script: terraform plan -out=tfplan
    displayName: 'Terraform Plan'

  # Step 6: Terraform Apply
  - script: terraform apply -auto-approve tfplan
    displayName: 'Terraform Apply'
```

Make sure to input your service connection name.

Finally [create a new pipeline](https://learn.microsoft.com/en-us/azure/devops/pipelines/create-first-pipeline?view=azure-devops&tabs=java%2Cbrowser) and then run it.

## Configuration



















